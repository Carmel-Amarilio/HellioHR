generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  passwordHash  String         @map("password_hash")
  role          Role           @default(VIEWER)
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  notifications Notification[]

  @@map("users")
}

enum Role {
  VIEWER
  EDITOR
}

model Candidate {
  id        String   @id // Preserve "cand-001" format
  name      String
  email     String   @unique
  phone     String
  skills    Json     // JSON array: ["React", "Node.js"]
  cvUrl     String?  @map("cv_url")
  status    Status   @default(ACTIVE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Extraction fields
  extractedSummary        String?   @db.Text @map("extracted_summary")
  extractedExperience     Json?     @map("extracted_experience") // [{ company, role, duration, achievements }]
  extractedEducation      Json?     @map("extracted_education") // [{ degree, institution, year }]
  lastExtractionDate      DateTime? @map("last_extraction_date")
  extractionMethod        String?   @map("extraction_method") // "heuristic" | "llm" | "hybrid"
  extractionStatus        String?   @map("extraction_status") // "pending" | "success" | "partial" | "failed"
  extractionPromptVersion String?   @map("extraction_prompt_version") // "cv-v1.0"

  positions CandidatePosition[]
  documents Document[]        @relation("CandidateDocuments")
  emailLogs EmailProcessingLog[]

  @@map("candidates")
}

enum Status {
  ACTIVE
  INACTIVE
}

model Position {
  id          String   @id // Preserve "pos-001" format
  title       String
  department  String
  description String   @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Extraction fields
  extractedSummary          String?   @db.Text @map("extracted_summary")
  extractedRequirements     Json?     @map("extracted_requirements") // [{ type, skill, yearsExp }]
  extractedResponsibilities Json?     @map("extracted_responsibilities") // [{ responsibility, category }]
  lastExtractionDate        DateTime? @map("last_extraction_date")
  extractionMethod          String?   @map("extraction_method")
  extractionStatus          String?   @map("extraction_status")
  extractionPromptVersion   String?   @map("extraction_prompt_version")

  candidates CandidatePosition[]
  documents  Document[]         @relation("PositionDocuments")
  emailLogs  EmailProcessingLog[]

  @@map("positions")
}

model CandidatePosition {
  candidateId String    @map("candidate_id")
  positionId  String    @map("position_id")
  assignedAt  DateTime  @default(now()) @map("assigned_at")

  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  position    Position  @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@id([candidateId, positionId])
  @@map("candidate_position")
}

model Document {
  id          String       @id @default(uuid())
  type        DocumentType
  fileName    String       @map("file_name")
  filePath    String       @map("file_path")
  candidateId String?      @map("candidate_id")
  positionId  String?      @map("position_id")
  createdAt   DateTime     @default(now()) @map("created_at")

  // Processing fields
  mimeType         String?   @map("mime_type")
  fileSize         Int?      @map("file_size")
  rawText          String?   @db.Text @map("raw_text")
  processingStatus String?   @map("processing_status") // "pending" | "extracted" | "enriched" | "failed"
  processingError  String?   @db.Text @map("processing_error")
  processedAt      DateTime? @map("processed_at")

  candidate  Candidate?   @relation("CandidateDocuments", fields: [candidateId], references: [id], onDelete: Cascade)
  position   Position?    @relation("PositionDocuments", fields: [positionId], references: [id], onDelete: Cascade)
  llmMetrics LlmMetric[]

  @@map("documents")
}

enum DocumentType {
  CV
  JOB_DESCRIPTION
  OTHER
}

model LlmMetric {
  id                String    @id @default(uuid())
  documentId        String?   @map("document_id")
  entityType        String    @map("entity_type") // "candidate" | "position"
  entityId          String?   @map("entity_id")
  modelName         String    @map("model_name") // "amazon.nova-lite-v1:0" | "anthropic.claude-3-5-sonnet..."
  promptVersion     String    @map("prompt_version")
  promptTokens      Int       @map("prompt_tokens")
  completionTokens  Int       @map("completion_tokens")
  totalTokens       Int       @map("total_tokens")
  estimatedCostUsd  Decimal?  @db.Decimal(10, 6) @map("estimated_cost_usd")
  latencyMs         Int?      @map("latency_ms")
  success           Boolean   @default(true)
  errorMessage      String?   @db.Text @map("error_message")
  createdAt         DateTime  @default(now()) @map("created_at")

  document          Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([documentId])
  @@index([entityType, entityId])
  @@index([modelName])
  @@map("llm_metrics")
}

model EmailProcessingLog {
  id               String    @id @default(uuid())
  gmailMessageId   String    @unique @map("gmail_message_id")
  subject          String
  sender           String
  receivedAt       DateTime  @map("received_at")
  classifiedAs     EmailType @map("classified_as")
  processingStatus String    @map("processing_status") // "pending" | "processed" | "failed"
  candidateId      String?   @map("candidate_id")
  positionId       String?   @map("position_id")
  documentId       String?   @map("document_id")
  errorMessage     String?   @db.Text @map("error_message")
  processedAt      DateTime  @default(now()) @map("processed_at")

  candidate        Candidate? @relation(fields: [candidateId], references: [id])
  position         Position?  @relation(fields: [positionId], references: [id])
  drafts           EmailDraft[]

  @@index([gmailMessageId])
  @@index([processingStatus])
  @@map("email_processing_log")
}

enum EmailType {
  CANDIDATE_APPLICATION
  POSITION_ANNOUNCEMENT
  OTHER
}

model EmailDraft {
  id                   String   @id @default(uuid())
  emailProcessingLogId String   @map("email_processing_log_id")
  gmailDraftId         String?  @map("gmail_draft_id")
  draftContent         String   @db.Text @map("draft_content")
  draftSubject         String   @map("draft_subject")
  draftStatus          String   @map("draft_status") // "created" | "sent" | "discarded"
  llmModel             String   @map("llm_model")
  promptVersion        String   @map("prompt_version")
  createdAt            DateTime @default(now()) @map("created_at")
  sentAt               DateTime? @map("sent_at")

  emailLog             EmailProcessingLog @relation(fields: [emailProcessingLogId], references: [id], onDelete: Cascade)

  @@map("email_drafts")
}

model Notification {
  id        String    @id @default(uuid())
  userId    String?   @map("user_id")
  type      String    // "email_processed" | "draft_created" | "error"
  title     String
  message   String    @db.Text
  metadata  Json?     // { emailId, candidateId, positionId, gmailDraftId }
  read      Boolean   @default(false)
  createdAt DateTime  @default(now()) @map("created_at")
  readAt    DateTime? @map("read_at")

  user      User?     @relation(fields: [userId], references: [id])

  @@index([userId, read])
  @@map("notifications")
}
